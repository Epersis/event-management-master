<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Process Ticket Sales - TicketMaster</title>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

  <style>
    body {
      background-color: #f8f9fa;
    }
    .navbar-brand {
      font-weight: bold;
    }
    .container {
      margin-top: 50px;
    }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container">
    <a class="navbar-brand" href="#">TicketMaster</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a class="nav-link" href="ticketOfficer.html">Home</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="ticketValidity.html">Ticket Validation</a>
        </li>
        <li class="nav-item active">
          <a class="nav-link" href="#">Process Ticket Sales</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="issueTickets.html">Issue E-Tickets</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      <h2>Process Ticket Sales</h2>
      <p>This is the page for processing on-site ticket sales.</p>
    </div>
  </div>

<script>
//   if (localStorage.getItem('customer_token')) {
//     const customer_token = localStorage.getItem('customer_token');
// }
// else {
//     window.location.href = "login.html";
// }
const app = Vue.createApp({
    created() {
        this.getAllAvailableEvents();
        this.getUserInfo();
    },

    data() {
        return {
            music_concert: [],
            theatre_show: [],
            seminar: [],
            other_event: [],
            events: [],
            ticketQuantity: 1,
            paymentMethod: "WALLET",
            walletBalance: 0,
        };
    },
    methods: {
        logout() {  
            localStorage.clear();
            window.location.href = 'login.html';
        },

        getUserInfo() {
            const URL = "http://localhost:8081/api/v1/users/profile";

            const headers = new Headers();
            const customer_token = localStorage.getItem('customer_token');
            headers.append('Authorization', `Bearer ${customer_token}`);

            return fetch(URL, {
                method: 'GET',
                headers: headers
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                this.walletBalance = data.walletDetails.balance
                return data
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
                // Rethrow the error to be handled by the caller
                throw error;
            });
        },


        getAllAvailableEvents() {
            const URL = `http://localhost:8081/api/v1/events`;

            // Create headers object
            const headers = new Headers();
            const customer_token = localStorage.getItem('customer_token');
            headers.append('Authorization', `Bearer ${customer_token}`);

            // Make fetch request with headers
            return fetch(URL, {
                method: 'GET',
                headers: headers
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => { 
                for (event of data.content) {
                    if (event.eventState == "ACTIVE") {
                        this.events.push(event)
                    }
                    if (event.eventState == "ACTIVE" && event.eventType == "MUSIC_CONCERT") {
                        this.music_concert.push(event);
                    }
                    if (event.eventState == "ACTIVE" && event.eventType == "THEATARE_SHOW") {
                        this.theatre_show.push(event);
                    }
                    if (event.eventState == "ACTIVE" && event.eventType == "SEMINAR") {
                        this.seminar.push(event);
                    }
                    if (event.eventState == "ACTIVE" && event.eventType == "OTHER") {
                        this.other_event.push(event);
                    }
                }

            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
                // Handle errors (e.g., show error message)
            });
        },

        openModal(event) {
            const modalId = 'modal-' + event.id;
            const modal = new bootstrap.Modal(document.getElementById(modalId));
            modal.show();
        },

        closeModal(event) {
            const modalId = 'modal-' + event.id;
            const modalElement = document.getElementById(modalId);
            const modalInstance = bootstrap.Modal.getInstance(modalElement);
            this.ticketQuantity = 1;
            modalInstance.hide();
        },



        processTicketsPurchase(event) {
        this.getUserInfo().then(customer_info => {
            // Create headers object
            const headers = new Headers();
            const customer_token = localStorage.getItem('customer_token');
            headers.append('Authorization', `Bearer ${customer_token}`);
            headers.append('Content-Type', 'application/json'); // Set Content-Type header

            const requestBody = {
                bookingUserEmail: customer_info.email,
                bookingMobileNumber: customer_info.mobileNumber,
                eventId: event.id,
                numberOfTickets: this.ticketQuantity,
                transactionDetail: {
                    paymentMethod: this.paymentMethod
                }
            };

            const URL = "http://localhost:8081/api/v1/bookings";
            fetch(URL, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(requestBody)
            })
            .then(response => response.json())
            .then(data => {
                if (data.message != null) {
                    alert(data.message);
                }
                else {
                    alert("Tickets purchased successfully!")
                    console.log('Tickets purchased successfully:', data);

                    // Reload the events to get updated tickets quantity and wallet balance
                    this.music_concert = [];
                    this.theatre_show = [];
                    this.seminar = [];
                    this.other_event = [];
                    this.events = [];
                    this.getAllAvailableEvents();
                    this.getUserInfo();
                }

                this.closeModal(event);
                
            })
            .catch(error => {
                console.error('Error processing tickets purchase:', error);
            });

        }).catch(error => {
            console.error('Error fetching user info:', error);
        });
    }
    }
});

app.mount('#app');  

</script>
</body>